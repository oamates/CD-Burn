///////////////////////////////////////////////////////////////////////////////
/******************************************************************************
	Project		ZMediaServer
	ZRTPPacket	Header File
	Create		20110105		ZHAOTT		RTP
	Modify		20110719		ZHAOTT		RTP
******************************************************************************/
///////////////////////////////////////////////////////////////////////////////
#ifndef	_ZRTPPACKET_H_
#define	_ZRTPPACKET_H_
///////////////////////////////////////////////////////////////////////////////
#include "Common.h"
#include "ZOSPool.h"
///////////////////////////////////////////////////////////////////////////////
class	ZRTPPacket;
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
#define	DEFAULT_RTP_BUFFER_USED		1440 //when tcp send, 1440 will better than 1460
///////////////////////////////////////////////////////////////////////////////
#define	DEFAULT_RTP_BUFFER_MAX		8192
//#define	DEFAULT_RTP_BUFFER_MAX		1536
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
//RTP Packet
///////////////////////////////////////////////////////////////////////////////
//|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
//+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
//|V=2|P|X|   CC  |M|    PT       |				 SN               |
//+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
//|                           Time Stamp                          |
//+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
//|                              SSRC                             |
//+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
class ZRTPHeader
{
///////////////////////////////////////////////////////////////////////////////
public:
	ZRTPHeader();
	virtual	~ZRTPHeader();
///////////////////////////////////////////////////////////////////////////////
public:
	BOOL	Set(const char* sBuffer,int nBuffer);
///////////////////////////////////////////////////////////////////////////////
protected:
	struct	RTPHEADER{
	UINT8	m_nCount:		4;
	UINT8	m_nExtension:	1;
	UINT8	m_nPadding:		1;
	UINT8	m_nVersion:		2;
	UINT8	m_nPayload:		7;
	UINT8	m_nMarker:		1;
	UINT16	m_nSequence;
	UINT32	m_nTimeStamp;
	UINT32	m_nSSRC;
	};
	RTPHEADER	*m_pHeader;
///////////////////////////////////////////////////////////////////////////////
};
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
class ZRTPPacket : public ZObject
{
///////////////////////////////////////////////////////////////////////////////
public:
	ZRTPPacket();
	virtual ~ZRTPPacket();
///////////////////////////////////////////////////////////////////////////////
public:
	char*			GetPacketPointer() CONST;
	int				GetPacketLength() CONST;
    int             GetPacketPayloadLength() CONST;
	int				SetPacketData(const char* sData,const int nData);
///////////////////////////////////////////////////////////////////////////////
public:
	BOOL			IsValid();
///////////////////////////////////////////////////////////////////////////////
public:
	DWORD			GetVersion();
	DWORD			GetPadding();
	DWORD			GetExtension();
	DWORD			GetCount();
	DWORD			GetMarker();
	DWORD			GetPayload();
	WORD			GetSequence();
	DWORD			GetTimeStamp();
	DWORD			GetPacketSSRC();
    static DWORD    GenerateSSRC();
	UINT64          GetRecievedTime();
///////////////////////////////////////////////////////////////////////////////
protected:
	ZRTPPacket*		m_pFreeNext;
	ZRTPPacket*		m_pUsedNext;
///////////////////////////////////////////////////////////////////////////////
protected:
	char*			m_pPacketBuffer;
	int				m_nPacketBuffer;
	int				m_nPacketLength;
	ZRTPHeader		m_ePacketHeader;
	UINT64          m_nTimeReceived;
///////////////////////////////////////////////////////////////////////////////
public:
	STATIC CONST DWORD		m_nSupportedVersion;
	STATIC CONST DWORD		m_nMaxCount;
	STATIC CONST INT		m_nPacketHeaderSize;
    static DWORD            m_nGlobleSSRC;
///////////////////////////////////////////////////////////////////////////////
public:

public:
	STATIC	DWORD	CalcSequence(DWORD Sequence);
///////////////////////////////////////////////////////////////////////////////
public:
	friend	class	ZRTPStream;
	friend	class	ZOSPool<ZRTPPacket>;
///////////////////////////////////////////////////////////////////////////////
};
///////////////////////////////////////////////////////////////////////////////
#endif	//_ZRTPPACKET_H_
///////////////////////////////////////////////////////////////////////////////
